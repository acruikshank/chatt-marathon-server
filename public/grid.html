<html>
  <head>
    <title>Grid</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <style type="text/css">
      html, body, canvas { margin:0; width: 100%; height:100%; overflow: hidden;}
      body { background-color: #212;
        background: linear-gradient(to right, #47273a 0%,#43666d 100%);
      }
      img { width: 200%; height: 200%; margin-left: -33%; position: absolute; opacity: .15 }
      xcanvas {width: 49%; vertical-align: top;}
      video {position: absolute;}
    </style>
    <script src="scripts/sylvester.js" type="text/javascript"></script>
    <script src="scripts/glUtils.js" type="text/javascript"></script>
    <script src="scripts/sketchbook-util.js" type="text/javascript"></script>
    <script src="scripts/recorded-data.js" type="text/javascript"></script>
    <script src="scripts/live-data.js" type="text/javascript"></script>
    <script id="flat" type="x-shader/x-vertex">
      precision mediump float;

      attribute vec2 position;

      void main(void) {
        gl_Position = vec4(position, 0.0, 1.0);
      }
    </script>

    <script id="grid" type="x-shader/x-fragment">
      precision mediump float;

      uniform float theta;
      uniform vec2 size;
      uniform vec4 diagonals;

      void main(void) {
        /*
            compute guassian about angles (aShape)
            compute function that is zero at zero, 1 at x and 0 at inf (rShape)
            compute gaussian at center (cShape)
            put edge signals in vec4 (outerSignal)
            shape = outerSignal (dot) aShape * rShape + centerSignal * cShape
         */
        vec2 center = size*vec2(.33,.5);
        vec2 offset = gl_FragCoord.xy - center;
        float angle = atan(offset.y, offset.x);
        float norm = length(offset);

        vec4 angleOffset = diagonals - angle;
        vec4 aShape = exp(-angleOffset*angleOffset*6.0);
        float logR = log(norm*0.0025);
        float rShape = exp(-logR*logR*10.0);
        float cShape = exp(-norm*norm * 0.00004);

        // float distort = 1.0-(.1*(1.0+sin(theta*.1))*exp(-offset*offset*.00001) * .2* sin(offset*.1 + theta*.1));

        float distort = 1.0 + norm * 0.01;
        float shape = dot(aShape,vec4(rShape)) + cShape;
        vec2 mapCoord = center + offset * mix(1.0,.6 + .35*sin(norm*.06 + .025*theta),shape);
        vec2 coord = sin(.16 *mapCoord);
        float alpha = clamp(1.0 - length(offset)*.0012,0.0,1.0)*50.0*(max(0.0,max(coord.x, coord.y))-.98);
        // gl_FragColor = vec4(1.0,1.0,1.0, dot(aShape,vec4(rShape)) + cShape );
        gl_FragColor = vec4(1.0,1.0,1.0, alpha);
      }
    </script>
    </script>

  </head>

  <body>
    <img src="runner.jpeg"/>
    <canvas id="c">
      Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
    </canvas>
  </body>
  <script>
 var canvas;
 var gl;
 var gridShader;
 var coordAttribute;
 var gridBuffer;
 var dTheta = 1;
 var theta = 0;

var sampler = location.hash
  ? RecordedData(location.hash.slice(1), 10)
  : LiveData();

start()

function start() {
  canvas = document.getElementById("c");
  canvas.width = canvas.offsetWidth * (devicePixelRatio||1);
  canvas.height = canvas.offsetHeight * (devicePixelRatio||1);

  gl = canvas.getContext("experimental-webgl");

  if (gl) {
    gl.clearColor(0, 0, 0, 0.0);  // Clear to black, fully opaque
    gl.enable( gl.BLEND );
    gl.blendEquation( gl.FUNC_ADD );
    gl.blendFunc( gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA );

    gridShader = SketchbookUtil.createProgram(gl, 'flat', 'grid');

    render();
  }
}

function render() {
  theta += dTheta;

  gl.bindFramebuffer(gl.FRAMEBUFFER, null);
  gl.useProgram(gridShader);

  var thetaUniform = gl.getUniformLocation(gridShader, "theta");
  gl.uniform1f(thetaUniform, theta);

  var thetaUniform = gl.getUniformLocation(gridShader, "size");
  gl.uniform2f(thetaUniform, canvas.width, canvas.height);

  var diagonalsUniform = gl.getUniformLocation(gridShader, "diagonals");
  gl.uniform4f(diagonalsUniform, -Math.PI*1/4, -Math.PI*3/4, Math.PI*1/4, Math.PI*3/4);

  gl.viewport(0, 0, canvas.width, canvas.height);
  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
  SketchbookUtil.drawFlatBackground(gl, gridShader);

  requestAnimationFrame(render);
}

  </script>
</html>
