<html>
  <head>
    <title>Chattanooga Marathon Brainwaves</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link href='https://fonts.googleapis.com/css?family=Dosis:600' rel='stylesheet' type='text/css'>
    <link rel="icon" type="image/png" href="favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="favicon-16x16.png" sizes="16x16" />
    <style type="text/css">
    @font-face {
      font-family: 'metropolis';
      src: url('metropolis/Metropolis-Regular.otf');
    }
    @font-face {
      font-family: 'metropolis-bold';
      src: url('metropolis/Metropolis-Bold.otf');
    }
    html, body { margin:0; width: 100%; height:100%; overflow: hidden; font-family: 'metropolis', sans-serif; }
    body {
      background-color: #FAF4EF;
      background: linear-gradient(to bottom, #EDF1EF 0%,#FAF4EF 100%);
    }
    .logo { position: absolute; top: 4vh; left: 4vh; width: 16vw; }
    .links { position: absolute; top: 34vh; left: 2.2vw; width: 34vw; z-index: 1; }
    a { color: rgb(62, 111, 141); text-decoration: none; margin: 5vw 0 0; display: inline-block;}
    a h2 { font-family: metropolis-bold; margin: 0; font-size: 4.5vw; line-height: 4vw; }
    a:first-child { margin: 2vw 0 0; }
    a h3 { font-family: metropolis; margin: 0; font-size: 1.5vw; }
    .grid { position:absolute; width: 36vw; height: 36vw; right: 24vw; top: -2vw; }
    .activity-legend { position: absolute; width: 24vw; height: 24vw; right: 30vw; top: 4vw; opacity: 1; }
    .runner { top: 0; position:absolute; width: 100%; height: 100vh; left:100%; text-align: right; display: none;
      opacity: 1;
      transition: left .5s ease, opacity .2s linear; }
    .runner.ondeck { left: 0; display: block; opacity:0; }
    .runner.active { left: 0; display: block; }
    .runner.exiting { left: 0; display: block; opacity: 0; }
    .runner img.background { position: absolute; top: 0%; width: 30vw; right: 4vw; opacity: .5;}
    .runner .shade { position: absolute; top: 50vh; width: 50vw; height: 40%; right: 6vw;
      opacity: 0; transition: opacity 1s ease-in;
      background-color: rgba(248, 244, 239, 0.5);
      background: linear-gradient(to bottom, rgba(250, 244, 239, 0.5) 0%, rgb(248, 244, 239) 50%, rgb(248, 244, 239) 100%);
      border-top: 1px solid rgb(62, 111, 141);
    }
    .runner.active .shade, .runner.active .bio { opacity: 1; }
    .runner .bio { font-size: 2vh; line-height: 3vh; position: absolute; top: 52vh; height: 24vh; width:50%; right: 4vw;
      opacity: 0; transition: opacity 1s ease-in; text-align: left;
      padding: 0 0 0 0; margin: 0 0 0 0; overflow: hidden; color: #787872;
    }
    #names { position: absolute; width:100%; height: 100%; top:0; left:0; z-index: 1; }
    #names h2 {
      font-size: 1.8vh; position: absolute; top: 4%; margin: 0; right: 0; color: rgba(100,100,100,.9); text-transform: uppercase;
      cursor: pointer; white-space: nowrap;
      transition: top .4s ease, right 1.3s ease, color .3s linear, font-size 1s ease, width 1s ease;
      width: 8%;
      border-top: 1px solid rgb(125, 125, 125);
      padding: 1vh 1vh 4vh;
    }
    #names h2.name1 {top:11%;}
    #names h2.name2 {top:18%;}
    #names h2.name3 {top:25%;}
    #names h2.name4 {top:32%;}
    #names h2.name5 {top:39%;}
    #names h2.name6 {top:46%;}
    #names h2.name7 {top:53%;}
    #names h2.name8 {top:60%;}
    #names h2.name9 {top:67%;}
    #names h2.selected {
      text-transform: capitalize; top:47vh; right:42vw; font-size: 6vh; width: 20vw; font-family: 'metropolis-bold', sans-serif;
      color: rgb(62, 111, 141); border-color: rgb(62, 111, 141);
    }
    #names h2 .color {
      display: inline-block;
      display: none;
      height: 2vh;
      width: 2vh;
      vertical-align: baseline;
      border: solid;
      border-width: .65vh;
      margin-left: .25em;
      border-radius: 4vh;
    }
    #names h2.selected .color { height: 2.5vh; width: 2.5vh; border-width: 1vh; }
    #names .name0 .color { border-color: rgba(22, 105, 128, 1); }
    #names .name1 .color { border-color: rgba(224, 45, 27, 0.87); }
    #names .name2 .color { border-color: rgba(224, 145, 27, 0.87); }
    #names .name3 .color { border-color: rgba(69, 164, 11, 0.87); }
    #names .name4 .color { border-color: rgba(18, 175, 123, 0.87); }
    #names .name5 .color { border-color: rgba(128, 41, 205, 0.87); }
    #names .name6 .color { border-color: rgba(236, 18, 201, 0.87); }
    #names .name7 .color { border-color: rgba(66, 65, 68, 0.87); }
    #names .name8 .color { border-color: rgba(157, 157, 157, 0.87); }

    .map { position: absolute; left: -10%; top: -20%; width: 80%; }
    #map-background { width: 100%; opacity: .1;}
    #location { position: absolute; left: 0; width: 100%; top: 0; height: 100%;}
    .graphs { position: absolute; left:0; width: 100%; bottom:0; height: 22vh; background-color: rgba(0,0,0,.0); }
    .time-series { position: absolute; bottom:0; left:0; width: 90%; height: 22vh; transition: bottom .3s ease; }
    .exiting .time-series, .ondeck .time-series { bottom:-22vh; }
    .legend { position: absolute; bottom: 0; width: 18%; left: 91%; height: 22vh; text-align: left; z-index: 1; }
    .legend span {
      display: block; height: 33%; background: rgba(0,0,0,.2); margin-bottom: 1%; padding: .5em;
      box-sizing: border-box; color: #faf4e4; font-size: 1.75vh;
    }
    .legend .activity {
      background-color: rgba(0,0,0,.5);
      background: linear-gradient(to bottom, rgba(0,0,0,.5) 0%,rgba(0,0,0,0) 100%);
    }
    .legend .focus {
      background-color: rgba(61, 131, 161, 1);
      background: linear-gradient(to bottom, rgba(61, 131, 161, 1) 0%, rgba(61, 161, 134, 0.5) 50%, rgba(61, 161, 110, 0) 100%);
    }
    .legend .excitement {
      background-color: rgba(167, 39, 62, 1);
      background: linear-gradient(to bottom, rgba(167, 39, 62, 1) 0%, rgba(213, 57, 7, 0.6) 30%, rgba(203, 184, 91, .2) 100%);
    }

    @media (max-width: 640px) {
      body { overflow-y: auto; }
      .bounds { position: absolute; width: 100%; height: 100vh; top: 0; left: 0; overflow: hidden; }
      .grid { display: none; }
      .activity-legend { display: none; }
      .time-series { width: 100%; }
      .legend { display: none; }
      .map { width: 512px; }
      .runner img.background { width: 192px; }
      .runner .shade { top: 30vh; height: 60%; }
      .runner.active .shade, .runner.active .bio { opacity: 1; }
      .runner .bio { top: 32vh; height: 44vh; }

    }
    </style>
    <script src="scripts/sylvester.js" type="text/javascript"></script>
    <script src="scripts/glUtils.js" type="text/javascript"></script>
    <script src="scripts/sketchbook-util.js" type="text/javascript"></script>
    <script src="scripts/recorded-data.js" type="text/javascript"></script>
    <script src="scripts/live-data.js" type="text/javascript"></script>
    <script src="scripts/playback-data.js" type="text/javascript"></script>
    <script src="scripts/grid.js" type="text/javascript"></script>
    <script src="scripts/location-multi.js" type="text/javascript"></script>
    <script src="scripts/time-series.js" type="text/javascript"></script>
    <script id="flat" type="x-shader/x-vertex">
      precision mediump float;

      attribute vec2 position;

      void main(void) {
        gl_Position = vec4(position, 0.0, 1.0);
      }
    </script>

    <script id="grid" type="x-shader/x-fragment">
      precision mediump float;

      uniform float theta;
      uniform vec2 size;
      uniform vec4 diagonals;
      uniform float samples[25];
      uniform vec2 offset;
      uniform float weight;

      void main(void) {
        vec2 effectiveSize = vec2(1400.0);
        vec2 center = effectiveSize*offset;
        vec2 offset = effectiveSize*gl_FragCoord.xy/size.x - center;
        float angle = atan(offset.y, offset.x);
        float norm = length(offset);

        vec4 angleOffset = diagonals - angle;
        vec4 aShape = exp(-angleOffset*angleOffset*6.0);
        float logR = log(norm*0.003);
        float rShape = exp(-logR*logR*10.0);
        float cShape = exp(-norm*norm * 0.00008);

        vec4 signal = vec4(samples[0], samples[5], samples[10], samples[15]);

        // float distort = 1.0-(.1*(1.0+sin(theta*.1))*exp(-offset*offset*.00001) * .2* sin(offset*.1 + theta*.1));

        float distort = 1.0 + norm * 0.01;
        float shape = rShape * dot(aShape,1.5*weight*signal) + cShape * weight*samples[20];
        vec2 mapCoord = offset * mix(1.0,.6 + .35*sin(norm*.03 + .1*theta),shape);
        vec2 coord = sin(0.15 *mapCoord);
        float alpha = 50.0*(max(0.0,max(coord.x, coord.y))-1.0 + .04*shape);
        // gl_FragColor = vec4(1.0,1.0,1.0, dot(aShape,vec4(rShape)) + cShape );
        vec3 color = mix(vec3(0.4,0.48,0.4), vec3(0.3,0.45,0.5), clamp(4.0*shape,0.0,1.5));
        gl_FragColor = vec4(color, alpha);
      }
    </script>
  </head>

  <body>
    <img class="logo" src="cmbw-logo-2x.png"/>
    <div class="map">
      <img src="map-detailed-2017.png" id="map-background"/>
      <canvas id="location"></canvas>
    </div>
    <div class="links">
      <!-- <a href="5k.html">
        <h2>5K Race</h2>
        <h3>Streaming begins Sat. March 3 9:00a.m.</h3>
      </a> -->
      <a href="marathon.html">
        <h2>Full Marathon</h2>
        <h3>Live Now! - click here</h3>
      </a>
    </div>
    <img class="activity-legend" src="activity.png"/>
    <div class="legend">
      <span class="activity">ACTIVITY</span>
      <span class="focus">FOCUS</span>
      <span class="excitement">EXCITEMENT</span>
    </div>
    <div id="runner0" class="runner active">
      <div class="bounds">
        <img class="background" src="eric2.png"/>
        <div class="shade"></div>
      </div>
      <dir class="bio">The Chattanooga Marathon Brainwaves project will stream electroencephologram data from
        runners running the 5K race and the full and half marathon. We will be visulizing this data
        live on this website and on the Jumbotron at the finish line. Brainwave data will also be recorded for
        more in-depth scientific study. Brainwaves can be used to study the relationship between stress and
        performance. They can also be used to understand the relationship between the environment and peformance
        in ways that may lead to better race courses.
      </dir>
      <canvas id="grid0" class="grid">
        Your browser doesn't appear to support the WebGL needed to display this graphic.
      </canvas>
      <canvas id="time-series0" class="time-series"></canvas>
    </div>
  </body>
  <script>

  var runnerLocations;
  var currentIndex = 0;
  var timeouts = [], intervals = [], runners = [{}];
  var runner = runners[0];

  // runner.sampler = PlaybackData(['5A68593D'],
  //   new Date('2017/02/12 11:30:00 est'),
  //   new Date('2017/02/12 11:40:00 est'), function() { graph(0, runner.sampler) });

  runner.sampler = PlaybackData(['5A688F11'],
    new Date('2018/03/02 15:03:00 est'),
    new Date('2018/03/02 16:55:56 est'), function() { graph(0, runner.sampler) });


  var timeSeries = document.getElementById('time-series0');
  var ts0 = document.getElementById('time-series0');
  timeSeries.width = ts0.offsetWidth * (window.devicePixelRatio||1);
  timeSeries.height = ts0.offsetHeight * (window.devicePixelRatio||1);
  TimeSeries(timeSeries, runner.sampler, .001);

  function graph(index, sampler) {
    var canvas = document.getElementById('grid0');
    var canvas0 = document.getElementById('grid0');
    canvas.width = canvas0.offsetWidth * (window.devicePixelRatio||1);
    canvas.height = canvas0.offsetHeight * (window.devicePixelRatio||1);
    runners[index].grid = Grid(canvas, sampler, .5, .5, index!=0);
  }

  function selectionHandler(index) {
    return function() {
      currentIndex = index;

      clearTimeouts();
      clearIntervals();
      runners.forEach(function(runner, i) {
        runner.grid.disable();
      })
      runners[index].grid.enable();
      selectorForEach('#names h2', function(n,i) { n.setAttribute('class','name'+i) })
      document.querySelector('.name'+index).setAttribute('class','selected name'+index);

      selectorForEach('.runner', function(n,i) {
        n.setAttribute('class',/active/.exec(n.getAttribute('class')) ? 'runner exiting' : 'runner');
      })
      document.querySelector('#runner'+index).setAttribute('class','runner ondeck');

      clearableTimeout(function() {
        document.querySelector('.runner.ondeck').setAttribute('class','runner active');
      }, 300);


      document.querySelector('#runner'+index+' .bio').scrollTop = 0;
      clearableTimeout(function() {
        var bio = document.querySelector('.runner.active .bio');
        var timeSinceLastUpdate = new Date().getTime();
        clearableInterval(function() {
          var time = new Date().getTime();
          if (time - timeSinceLastUpdate > 200) {
            bio.scrollTop = bio.scrollTop + 1;
            timeSinceLastUpdate+= 200;
          }
        }, 20) },
      5000);

      runnerLocations.setActive(index);
    }
  }

  function clearableTimeout(f, ms) { timeouts.push(setTimeout(f,ms)); }
  function clearableInterval(f, ms) { intervals.push(setInterval(f,ms)); }
  function clearTimeouts() { timeouts.forEach(function(t) { clearTimeout(t); }); timeouts=[]; }
  function clearIntervals() { intervals.forEach(function(i) { clearInterval(i); }); intervals=[]; }

  function selectorForEach(selector, f) {
    var nodes = document.querySelectorAll(selector);
    for (var i=0, node; node = nodes[i]; i++) f(node,i);
  }

  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-93017945-1', 'auto');
    ga('send', 'pageview');

  </script>
</html>
